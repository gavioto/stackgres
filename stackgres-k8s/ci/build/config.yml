maven_opts: |
  -Dhttps.protocols=TLSv1.2
  -Dorg.slf4j.simpleLogger.showDateTime=true
  -Djava.awt.headless=true
  -XX:+UseParallelGC
maven_cli_opts: |
  --batch-mode
  --errors
  --fail-at-end
  --show-version
  -Dmaven.repo.local=.m2/repository
  -DinstallAtEnd=true
  -DdeployAtEnd=true
  -Dsurefire.useFile=false
  -Dsurefire.useFile=false
  -DtrimStackTrace=false
base_image: alpine:3.13.5
base_jvm_image: registry.access.redhat.com/ubi8/openjdk-11:1.3-15
base_native_image: registry.access.redhat.com/ubi8-minimal:8.3-298.1618432845
modules:
  stackgres:
    type: java
    path: stackgres-k8s/src/.
    sources:
      - stackgres-k8s/src/pom.xml
      - stackgres-k8s/src/checks
      - stackgres-k8s/src/operator-framework/pom.xml
      - stackgres-k8s/src/operator-framework/src
      - stackgres-k8s/src/test-util/pom.xml
      - stackgres-k8s/src/test-util/src
      - stackgres-k8s/src/common/pom.xml
      - stackgres-k8s/src/common/src
      - stackgres-k8s/src/operator/pom.xml
      - stackgres-k8s/src/operator/src
      - stackgres-k8s/src/api-web/pom.xml
      - stackgres-k8s/src/api-web/src
      - stackgres-k8s/src/jobs/pom.xml
      - stackgres-k8s/src/jobs/src
      - stackgres-k8s/src/cluster-controller/pom.xml
      - stackgres-k8s/src/cluster-controller/src
      - stackgres-k8s/src/ditributedlogs-controller/pom.xml
      - stackgres-k8s/src/ditributedlogs-controller/src
    post_build_commands:
      - 'microdnf install python3-pip jq'
      - 'pip3 install yamllint yq'
      - 'sh $SHELL_XTRACE stackgres-k8s/src/api-web/src/main/swagger/build.sh'
  admin-ui:
    type: web
    path: stackgres-k8s/src/admin-ui
    sources:
      - "stackgres-k8s/src/admin-ui/babel.config.js"
      - "stackgres-k8s/src/admin-ui/build.sh"
      - "stackgres-k8s/src/admin-ui/npmw"
      - "stackgres-k8s/src/admin-ui/package.json"
      - "stackgres-k8s/src/admin-ui/vue.config.js"
      - "stackgres-k8s/src/admin-ui/public"
      - "stackgres-k8s/src/admin-ui/src"
    build_commands:
      - cd stackgres-k8s/src/admin-ui
      - export HOME=/project
      - npm install
      - npm run build
      - sh $SHELL_XTRACE build.sh
  operator-jvm-image:
    type: jvm-image
    name: operator
    path: stackgres-k8s/src/operator
  restapi-jvm-image:
    type: jvm-image
    name: restapi
    path: stackgres-k8s/src/api-web
  jobs-jvm-image:
    type: jvm-image
    name: jobs
    path: stackgres-k8s/src/jobs
  cluster-controller-jvm-image:
    type: jvm-image
    name: cluster-controller
    path: stackgres-k8s/src/cluster-controller
  distributedlogs-controller-jvm-image:
    type: jvm-image
    name: distributedlogs-controller
    path: stackgres-k8s/src/distributedlogs-controller
  admin-ui-image:
    type: image
    path: stackgres-k8s/src/admin-ui
    base_image: registry.access.redhat.com/ubi8/nginx-118:1-18.1614609200
  operator-native:
    type: native
    name: operator
    path: stackgres-k8s/src/operator
  restapi-native:
    type: native
    name: restapi
    path: stackgres-k8s/src/api-web
  jobs-native:
    type: native
    name: jobs
    path: stackgres-k8s/src/jobs
  cluster-controller-native:
    type: native
    name: cluster-controller
    path: stackgres-k8s/src/cluster-controller
  distributedlogs-controller-native:
    type: native
    name: distributedlogs-controller
    path: stackgres-k8s/src/distributedlogs-controller
  operator-native-image:
    type: native-image
    name: operator
    path: stackgres-k8s/src/operator
  restapi-native-image:
    type: native-image
    name: restapi
    path: stackgres-k8s/src/api-web
  jobs-native-image:
    type: native-image
    name: jobs
    path: stackgres-k8s/src/jobs
  cluster-controller-native-image:
    type: native-image
    name: cluster-controller
    path: stackgres-k8s/src/cluster-controller
  distributedlogs-controller-native-image:
    type: native-image
    name: distributedlogs-controller
    path: stackgres-k8s/src/distributedlogs-controller
  helm-packages:
    type: resource
    sources:
      - stackgres-k8s/install/helm/stackgres-operator
      - stackgres-k8s/install/helm/stackgres-cluster
      - stackgres-k8s/install/helm/build-helm-packages.sh
    build_image: dtzar/helm-kubectl:3.3.1
    build_commands:
      - export HOME=/project
      - sh $SHELL_XTRACE stackgres-k8s/install/helm/build-helm-packages.sh
    target: stackgres-k8s/install/helm/target/packages
  helm-templates:
    type: resource
    sources:
      - stackgres-k8s/install/helm/stackgres-operator
      - stackgres-k8s/install/helm/stackgres-cluster
      - stackgres-k8s/install/helm/build-helm-templates.sh
    build_image: dtzar/helm-kubectl:3.3.1
    build_commands:
      - export HOME=/project
      - sh $SHELL_XTRACE stackgres-k8s/install/helm/build-helm-templates.sh
    target: stackgres-k8s/install/helm/target/templates
stages:
  - stackgres: null
  - admin-ui: stackgres
  - operator-jvm-image: stackgres
  - restapi-jvm-image: stackgres
  - jobs-jvm-image: stackgres
  - cluster-controller-jvm-image: stackgres
  - distributedlogs-controller-jvm-image: stackgres
  - admin-ui-image: admin-ui
  - operator-native: stackgres
  - restapi-native: stackgres
  - jobs-native: stackgres
  - cluster-controller-native: stackgres
  - distributedlogs-controller-native: stackgres
  - operator-native-image: operator-native
  - restapi-native-image: restapi-native
  - jobs-native-image: jobs-native
  - cluster-controller-native-image: cluster-controller-native
  - distributedlogs-controller-native-image: distributedlogs-controller-native
  - helm-packages: null
  - helm-templates: null
