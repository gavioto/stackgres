ARG SOURCE_IMAGE_NAME

FROM "$SOURCE_IMAGE_NAME" as source
  USER root
  RUN mkdir -p /project/stackgres-k8s/src/
  ARG UID
  RUN chown "$UID" /project /project/stackgres-k8s /project/stackgres-k8s/src
  USER $UID

FROM docker.io/ongres/ubi-graalvm-maven:21.0.0.2-java11 as build
  USER root
  RUN mkdir -p /project/stackgres-k8s/src/
  ARG UID
  RUN chown "$UID" /project /project/stackgres-k8s /project/stackgres-k8s/src
  USER $UID
  COPY --chown="$UID" . /project/stackgres-k8s/src/.
  WORKDIR /project
  COPY --from=source /project /project-copy
  RUN cp -r /project-copy/. /project
  ARG MODULE_PATH
  ARG MAVEN_OPTS
  ARG MAVEN_CLI_OPTS
  ARG PRE_BUILD_COMMANDS
  USER root
  RUN sh -ec "$PRE_BUILD_COMMANDS"
  USER $UID
  ENV HOME=/project
  RUN mvn $MAVEN_CLI_OPTS clean install -P safer -pl "$MODULE_PATH"
  ARG POST_BUILD_COMMANDS
  USER root
  RUN sh -ec "$POST_BUILD_COMMANDS"
  USER $UID
  ARG IMAGE_NAME
  LABEL build-of=$IMAGE_NAME

FROM "$SOURCE_IMAGE_NAME" as package
  ARG MODULE_PATH
  COPY --from=build /project/stackgres-k8s/src/$MODULE_PATH/target /project/stackgres-k8s/src/$MODULE_PATH/target
  ARG MODULE_PACKAGE_PATH
  COPY --from=build /project/stackgres-k8s/src/.m2/repository/io/stackgres /project/stackgres-k8s/src/.m2/repository/io/stackgres
  WORKDIR /project
